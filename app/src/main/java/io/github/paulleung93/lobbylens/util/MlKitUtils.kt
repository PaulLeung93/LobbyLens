package io.github.paulleung93.lobbylens.util\n\nimport android.graphics.Bitmap\nimport com.google.mlkit.vision.common.InputImage\nimport com.google.mlkit.vision.face.FaceDetection\nimport com.google.mlkit.vision.face.FaceDetectorOptions\nimport com.google.mlkit.vision.segmentation.Segmentation\nimport com.google.mlkit.vision.segmentation.Segmenter\nimport com.google.mlkit.vision.segmentation.selfie.SelfieSegmenterOptions\nimport com.google.mlkit.vision.segmentation.SegmentationMask\nimport kotlinx.coroutines.suspendCancellableCoroutine\nimport kotlin.coroutines.resume\nimport kotlin.coroutines.resumeWithException\n\n/**\n * A utility object containing suspend functions for ML Kit operations,\n * such as face detection and selfie segmentation, designed for use with coroutines.\n */\nobject MlKitUtils {\n\n    /**\n     * Asynchronously detects faces in a bitmap image using ML Kit.\n     *\n     * @param bitmap The input image.\n     * @return A list of detected faces.\n     */\n    suspend fun detectFaces(bitmap: Bitmap) = suspendCancellableCoroutine {\ continuation ->\n        val image = InputImage.fromBitmap(bitmap, 0)\n        val options = FaceDetectorOptions.Builder()\n            .setPerformanceMode(FaceDetectorOptions.PERFORMANCE_MODE_ACCURATE)\n            .build()\n        val detector = FaceDetection.getClient(options)\n\n        detector.process(image)\n            .addOnSuccessListener { faces ->\n                if (continuation.isActive) {\n                    continuation.resume(faces)\n                }\n            }\n            .addOnFailureListener { e ->\n                if (continuation.isActive) {\n                    continuation.resumeWithException(e)\n                }\n            }\n    }\n\n    /**\n     * Asynchronously generates a segmentation mask for a person in an image.\n     *\n     * @param bitmap The input image.\n     * @return A [SegmentationMask] that separates the person from the background.\n     */\n    suspend fun segmentSelfie(bitmap: Bitmap) = suspendCancellableCoroutine {\ continuation ->\n        val image = InputImage.fromBitmap(bitmap, 0)\n        val options = SelfieSegmenterOptions.Builder()\n            .setDetectorMode(SelfieSegmenterOptions.SINGLE_IMAGE_MODE)\n            .build()\n        val segmenter = Segmentation.getClient(options)\n\n        segmenter.process(image)\n            .addOnSuccessListener { mask ->\n                if (continuation.isActive) {\n                    continuation.resume(mask)\n                }\n            }\n            .addOnFailureListener { e ->\n                if (continuation.isActive) {\n                    continuation.resumeWithException(e)\n                }\n            }\n    }\n}\n